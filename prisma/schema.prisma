// Prisma 7 Schema for Kontado Bill Tracking System
generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// Enums
enum Role {
  USER
  ADMIN
  GUEST
}

enum BillStatus {
  PENDING
  DUE_SOON
  OVERDUE
  PAID
  SKIPPED
}

enum RecurrenceFrequency {
  MONTHLY
  QUARTERLY
  BIANNUALLY
  YEARLY
}

// Models
model User {
  id             String   @id @default(uuid())
  email          String   @unique
  name           String
  password       String?  // Null for SSO/GUEST users
  role           Role     @default(USER)
  department     String?
  isKeycloakUser Boolean  @default(false)
  isActive       Boolean  @default(true)  // For deactivating users
  magicToken     String?  @unique         // For anonymous ticket viewing
  magicTokenExp  DateTime?                // Magic token expiration
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  createdBills      Bill[]
  createdCategories Category[]
  createdVendors    Vendor[]
  comments          Comment[]
  attachments       Attachment[]

  @@map("users")
}

model Category {
  id          String   @id @default(uuid())
  name        String
  description String?
  color       String?
  isGlobal    Boolean  @default(false)
  userId      String?  // Null for global categories
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user  User?  @relation(fields: [userId], references: [id], onDelete: Cascade)
  bills Bill[]

  @@unique([name, userId])
  @@map("categories")
}

model Vendor {
  id          String   @id @default(uuid())
  name        String
  email       String?
  phone       String?
  address     String?
  city        String?
  state       String?
  zip         String?
  country     String?
  website     String?
  logo        String?
  description String?
  createdById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  createdBy User?           @relation(fields: [createdById], references: [id], onDelete: SetNull)
  bills     Bill[]
  accounts  VendorAccount[]

  @@map("vendors")
}

model Bill {
  id                 String    @id @default(uuid())
  title              String
  description        String?
  amount             Decimal   @db.Decimal(10, 2)
  dueDate            DateTime
  paidDate           DateTime?
  status             BillStatus @default(PENDING)
  categoryId         String
  vendorId           String?   // Optional - can create bill without vendor
  vendorAccountId   String?   // Optional - can create bill without account
  createdById        String?   // Nullable for anonymous entries
  recurrencePatternId String?  @unique
  isRecurring        Boolean   @default(false)
  nextDueDate        DateTime?
  invoiceNumber      String?   // Optional invoice number from vendor
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // Relations
  category          Category          @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  vendor            Vendor?           @relation(fields: [vendorId], references: [id], onDelete: SetNull)
  vendorAccount     VendorAccount?    @relation(fields: [vendorAccountId], references: [id], onDelete: SetNull)
  createdBy         User?             @relation(fields: [createdById], references: [id], onDelete: SetNull)
  recurrencePattern RecurrencePattern?
  comments          Comment[]
  attachments       Attachment[]

  @@map("bills")
}

model RecurrencePattern {
  id          String              @id @default(uuid())
  frequency   RecurrenceFrequency
  dayOfMonth  Int                 // 1-31
  startDate   DateTime
  endDate     DateTime?
  billId      String              @unique
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  // Relations
  bill Bill @relation(fields: [billId], references: [id], onDelete: Cascade)

  @@map("recurrence_patterns")
}

model Comment {
  id        String   @id @default(uuid())
  content   String
  billId    String
  userId    String?  // Nullable for anonymous comments
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  bill Bill  @relation(fields: [billId], references: [id], onDelete: Cascade)
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("comments")
}

model Attachment {
  id          String   @id @default(uuid())
  fileName    String
  filePath    String
  fileSize    Int      // Size in bytes
  mimeType    String
  billId      String
  uploadedById String? // Nullable for anonymous uploads
  createdAt   DateTime @default(now())

  // Relations
  bill      Bill  @relation(fields: [billId], references: [id], onDelete: Cascade)
  uploadedBy User? @relation(fields: [uploadedById], references: [id], onDelete: SetNull)

  @@map("attachments")
}

model AccountType {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  accounts VendorAccount[]

  @@map("account_types")
}

model VendorAccount {
  id            String   @id @default(uuid())
  vendorId      String
  accountNumber String
  accountTypeId String?  // Optional: Reference to AccountType
  accountType   String?  // Optional: Legacy field for migration compatibility (will be removed later)
  nickname      String?  // Optional: "Primary Mortgage", "HELOC", etc.
  notes         String?  // Optional notes
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  vendor      Vendor      @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  type        AccountType? @relation(fields: [accountTypeId], references: [id], onDelete: SetNull)
  bills       Bill[]

  @@map("vendor_accounts")
}
